# Cancellation during cleanup is deferred
spawn {
    let file = open("test.txt")
    defer {
        # Even if cancelled here, cleanup must complete
        sleep(10)
        file | close
        print("cleanup complete")
    }
    sleep(1000)
} as task

sleep(1)
task | cancel
task | await
